# 新建服务和特征的方法

## 前提学习

### 回调函数的作用

```
gatts_event_handler 
```

这个函数的主要作用：导入 GATT 的 profiles。



```
gap_event_handler
```

GAP事件回调函数`gap_event_handler`，GAP 定义了在广播期间蓝牙设备的一些操作，蓝牙是通过GAP建立通信的



```
gatts_profile_a_event_handler 
```

蓝牙的处理函数，根据相关事件，进行相关的数据操作



### 流程

在没有连接之前：注册->创建->启动->添加特征->添加特征描述：

```
ESP_GATTS_REG_EVT—>
ESP_GATTS_CREATE_EVT—>
ESP_GATTS_START_EVT—>
ESP_GATTS_ADD_CHAR_EVT—>
ESP_GATTS_ADD_CHAR_DESCR_EVT
```

在 Demo 的`ESP_GATTS_REG_EVT`事件中，调用`esp_ble_gap_set_device_name(char *)`来设置蓝牙设备名字；调用`esp_ble_gap_config_adv_data()`来配置广播数据；

最后调用`esp_ble_gatts_create_service()`指定 `gatts_if `和` service_id `来创建服务<实际调用 btc_transfer_context() 来完成服务的创建和调用回调函数>。

服务创建完成就会触发回调函数向profile报告状态和服务ID。Service_id对于后面添加i`ncluded serivces `和` characteristics 和 descriptor` 都要用到。触发`ESP_GATTS_CREATE_EVT`事件

在Demo的`ESP_GATTS_CREATE_EVT`中调用`esp_ble_gatts_start_service(uint16_t service_handle)`来启动服务；

再调用 `esp_ble_gatts_add_char() `来添加特性(特征的UUID， 特征值描述符属性权限， 特征属性、特征值、属性响应控制字节)。

触发`ESP_GATTS_START_EVT`和`ESP_GATTS_ADD_CHAR_EVT`事件，在`ESP_GATTS_ADD_CHAR_EVT`事件中，获取特征值调用`esp_err_tesp_ble_gatts_add_char_descr()`来添加特征描述符。



在连接之后：

```
CONNECT_EVT—>
ESP_GATTS_MTU_EVT—>
GATT_WRITE_EVT—>
ESP_GATTS_CONF_EVT—>
GATT_READ_EVT
```



## 添加新特征的方法

```c

//添加模式和数据
static const uint8_t char_prop_D_test              = ESP_GATT_CHAR_PROP_BIT_WRITE | ESP_GATT_CHAR_PROP_BIT_READ;
static const uint8_t char_value_test[]                 = "i am lby!";


//添加特征配置和值
        /* Characteristic Declaration */
    [IDX_CHAR_D]      =
    {{ESP_GATT_AUTO_RSP}, {ESP_UUID_LEN_16, (uint8_t *)&character_declaration_uuid, ESP_GATT_PERM_READ,
      CHAR_DECLARATION_SIZE, CHAR_DECLARATION_SIZE, (uint8_t *)&char_prop_D_test}},

    /* Characteristic Value */
    [IDX_CHAR_VAL_D]  =
    {{ESP_GATT_AUTO_RSP}, {ESP_UUID_LEN_16, (uint8_t *)&GATTS_CHAR_UUID_TEST_D, ESP_GATT_PERM_READ | ESP_GATT_PERM_WRITE,
      GATTS_DEMO_CHAR_VAL_LEN_MAX, sizeof(char_value_test), (uint8_t *)char_value_test}},
```



## 添加服务的方法

在例程的基础上进行修改

```c
#define SVC_INST_ID1                 1   //40
uint16_t heart_rate_handle_table2[HRS_IDX_NB2];  //56

static const uint16_t GATTS_SERVICE_UUID_TEST2      = 0x00EE;
static const uint16_t GATTS_CHAR_UUID_TEST_A2       = 0xEE01;  //169

//新建一个服务属性函数
static const esp_gatts_attr_db_t gatt_db2[HRS_IDX_NB2] =
{
    // Service Declaration2
    [IDX_SVC2]        =
    {{ESP_GATT_AUTO_RSP}, {ESP_UUID_LEN_16, (uint8_t *)&primary_service_uuid, ESP_GATT_PERM_READ,
      sizeof(uint16_t), sizeof(GATTS_SERVICE_UUID_TEST2), (uint8_t *)&GATTS_SERVICE_UUID_TEST2}},

    /* Characteristic Declaration */
    [IDX_CHAR_A2]     =
    {{ESP_GATT_AUTO_RSP}, {ESP_UUID_LEN_16, (uint8_t *)&character_declaration_uuid, ESP_GATT_PERM_READ,
      CHAR_DECLARATION_SIZE, CHAR_DECLARATION_SIZE, (uint8_t *)&char_prop_read_write}},

    /* Characteristic Value */
    [IDX_CHAR_VAL_A2] =
    {{ESP_GATT_AUTO_RSP}, {ESP_UUID_LEN_16, (uint8_t *)&GATTS_CHAR_UUID_TEST_A2, ESP_GATT_PERM_READ | ESP_GATT_PERM_WRITE,
      GATTS_DEMO_CHAR_VAL_LEN_MAX, sizeof(char_value), (uint8_t *)char_value}}
};



//当启动服务完成时，事件发生  创建第二个server
case ESP_GATTS_START_EVT:
            if(create_tab1 == false) {
                ESP_LOGI(GATTS_TABLE_TAG, "SERVICE_START_EVT1, status %d, service_handle %d", param->start.status, param->start.service_handle);
                esp_err_t create_attr_ret1 = esp_ble_gatts_create_attr_tab(gatt_db2, gatts_if, HRS_IDX_NB2, SVC_INST_ID1);
                if (create_attr_ret1){
                    ESP_LOGE(GATTS_TABLE_TAG, "create attr table2 failed, error code = %x", create_attr_ret1);
                }
                create_tab1 = true;
            } else {
                ESP_LOGI(GATTS_TABLE_TAG, "SERVICE_START_EVT2, status %d, service_handle %d", param->start.status, param->start.service_handle);
            }
            break;


//当 gatt 创建表完成时，事件发生  进行判断  看看创建是否成功了
case ESP_GATTS_CREAT_ATTR_TAB_EVT:{
            if(create_tab1 == false) {
                if (param->add_attr_tab.status != ESP_GATT_OK){
                    ESP_LOGE(GATTS_TABLE_TAG, "create attribute table failed, error code=0x%x", param->add_attr_tab.status);
                }
                else if (param->add_attr_tab.num_handle != HRS_IDX_NB){
                    ESP_LOGE(GATTS_TABLE_TAG, "create attribute table abnormally, num_handle (%d) \
                            doesn't equal to HRS_IDX_NB(%d)", param->add_attr_tab.num_handle, HRS_IDX_NB);
                }
                else {
                    ESP_LOGI(GATTS_TABLE_TAG, "create attribute table successfully, the number handle = %d\n",param->add_attr_tab.num_handle);
                    memcpy(heart_rate_handle_table, param->add_attr_tab.handles, sizeof(heart_rate_handle_table));
                    esp_ble_gatts_start_service(heart_rate_handle_table[IDX_SVC]);
                }
            } else {
                if (param->add_attr_tab.status != ESP_GATT_OK){
                    ESP_LOGE(GATTS_TABLE_TAG, "create attribute table failed, error code=0x%x", param->add_attr_tab.status);
                }
                else if (param->add_attr_tab.num_handle != HRS_IDX_NB2){
                    ESP_LOGE(GATTS_TABLE_TAG, "create attribute table abnormally, num_handle (%d) \
                            doesn't equal to HRS_IDX_NB(%d)", param->add_attr_tab.num_handle, HRS_IDX_NB2);
                }
                else {
                    ESP_LOGI(GATTS_TABLE_TAG, "create attribute table successfully, the number handle = %d\n",param->add_attr_tab.num_handle);
                    memcpy(heart_rate_handle_table2, param->add_attr_tab.handles, sizeof(heart_rate_handle_table2));
                    esp_ble_gatts_start_service(heart_rate_handle_table2[IDX_SVC2]);
                }  
            }
            break;
        }
```

