# 启动流程

一级引导程序

固化在ROM里面，复位后执行复位向量，PRO CPU 会执行所有的初始化操作，根据 `GPIO_STRAP_REG` 寄存器的值来确定 ESP32-S3 的启动模式，从 flash 的 0x0 偏移地址处加载二级引导程序至 RAM 



[二级引导程序](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/api-guides/startup.html#second-stage-bootloader)

从 flash 中加载分区表和主程序镜像至内存中，主程序中包含了 RAM 段和通过 flash 高速缓存映射的只读段。

二级引导程序默认从 flash 的 `0x8000` 偏移地址处（[可配置的值](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/api-reference/kconfig.html#config-partition-table-offset)）读取分区表

- 对于在内部 [IRAM（指令 RAM）](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/api-guides/memory-types.html#iram) 或 [DRAM（数据 RAM）](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/api-guides/memory-types.html#dram) 中具有加载地址的段，将把数据从 flash 复制到它们的加载地址处。
- 对于一些加载地址位于 [DROM（数据存储在 flash 中）](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/api-guides/memory-types.html#drom) 或 [IROM（代码从 flash 中运行）](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32s3/api-guides/memory-types.html#irom) 区域的段，通过配置 flash MMU，可为从 flash 到加载地址提供正确的映射。



当一级引导程序校验并加载完二级引导程序后，它会从二进制镜像的头部找到二级引导程序的入口点，并跳转过去运行。





## 应用程序启动阶段

- 硬件和基本 C 语言运行环境的端口初始化。 配置时钟频率，内部存储器之类的
- 软件服务和 FreeRTOS 的系统初始化。初始化堆分配器，初始化 SPI flash API 支持。初始化组件，FreeRTOS 调度器开始运行。
- 运行主任务并调用 `app_main`。