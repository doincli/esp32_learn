# 试用期工作总结报告

数字组 嵌入式开发工程师 李博宇

从6月1日入职，不知不觉已经在乐鑫大家庭工作将近两个月的时间了。在这两个月的时间里，我的同事们给了我很多帮助，让我逐渐适应了工作环境，并且对未来从事的工作有了清晰的认知。在这里对入职以来的工作做一个总结报告。

## 1.主要的工作内容

在试用期工作的这两个月时间中，我的主要工作内容主要有以下6个方面：

1. ESP-IDF框架学习与调研
2. ESP32蓝牙Mesh组网
3. OBD检测组件
4. i2c读取QAM芯片加速度组件编写
5. 射频模块适配
6. 蓝牙GATTS传输与芯片自测

我的工作总结报告也将主要围绕这6个方面进行介绍与描述

### 1.1 ESP-IDF框架学习与调研

这部分工作主要是对ESP-IDF相关框架、相关知识以及工具的学习。

完成了关于JTAG板级、Trace堆栈跟踪、以及ETM技术的相关调研报告。

#### 1.1.1 ESP-IDF相关框架学习

1. 学习ESP-IDF框架的编译构建过程，了解公司的开发流程
2. 学习GIT的基本用法，如remote、push、pull、checkout、rebase、reset等
3. 学习在命令行与vscode插件两种情况下使用OpenOCD以及GDB对ESP芯片进行调试

#### 1.1.2 完成ESP相关技术调研报告

1. 完成关于JTAG板级调试的调研报告，包括如何配置、使用、以及问题处理的方法
2. 完成Trace堆栈跟踪的调研报告，包括如何在特定节点插入相关的日志代码来实现日志检测
3. 完成ETM技术的调研报告，在此基础上分析nRF52832中PPI技术与ESP32的ETM技术的异同点

#### 1.1.3 工作思考

1. 在对ESP-IDF框架进行学习的过程中，需要详细了解相关的开发流程以及使用方法如Git、GDB、Jtag、trace等，这样才可以更好的实现自己的目标。
2. ESP-IDF框架的具体结构以及其强大功能，ESP-IDF将整个框架分成example、compinents、tools等多层结构，分层开发的特点使开发人员易于维护并且具有良好的扩展性以及实时更新性，无论是组件还是底层驱动，都可以做到便捷快速的上线更新。可以极大方便开发者的开发。
3. 在学习PPI技术的过程中，了解到CHENSET和CHENCLR 的由来，明白了它们的设置是在硬件层面实现原子操作，可以有效的维护不同通道的状态

### 2.ESP32蓝牙Mesh组网

学习并使用ESP32进行蓝牙的配网、组网以及组网内部的数据通信，编写相关文档。

#### 2.1 工作内容

1. 实现配网：通过设置Provisioner的uuid_match来检测固定范围uuid的蓝牙设备，并且将程序密钥以及应用密钥完成绑定，交换身份信息完成绑定
2. 实现组网：通过开辟多个存储节点来保留多个蓝牙设备信息，并且将其id进行统一管理
3. 实现数据通信：利用两个esp32开发板。一块用作prov 并且注册client模型，第二块板子注册server模型实现开发板上灯的亮灭

#### 2.2工作思考

1. 了解到蓝牙Mesh组网的基本方法：即信标、邀请、交换公钥、身份认证、分发配网等基本过程。
2. 通过修改例程在板间实现配网、组网、数据传输等功能中，应该根据不同的事件来使用相关的API。
3. Mesh网络节点直接通过消息来传递信息，而模型就是实现消息发送的方法，模型包括状态以及操作码等等。所以需要仔细了解相关的协议栈才可以实现自己想要的功能。
4. Mesh组网利用状态机以及回调函数可以在应用层编写相关程序来实现配网、组网以及数据发送。根据内核传回的不同事件来实现想要的功能

### 3.OBD检测组件

为了实现检测车辆状况并通过终端进行显示，需要使用esp32进行车辆的OBD检测。
完成OBD相关组件的初步编写，可以实现同时支持两种协议以及两种CAN总线的速率。

#### 3.1工作内容

1. 通过控制CAN总线速率实时探测车辆的总线速率，并建立相关通信。
2. 使用轮询查找的方式找到正确的协议，当获得找到正确协议时候，跳出轮询状态
3. 根据OBD-II协议编写相关命令发送到OBD模拟器
4. 根据OBD-II协议解析OBD模拟器返回的数据，并且得到相关数据。

#### 3.2工作思考

1. 编写组件时候要按照组件的结构规范来编写，正常的结构规范如下
   <img src="https://image-1302263000.cos.ap-nanjing.myqcloud.com/img/image-20230702104126693.png" alt="image-20230702105508119" style="zoom: 67%;" />
2. 编写组件时，该组件应该尽量独立，实现功能尽可能集成到一块
3. 可以使用状态机来实现不同协议的轮询检测，当检测到正确的协议保持相关配置
4. 编写组件时，相关的接口应该尽量简单，不需要外部提供数据的API应该尽量合并，方便开发者调用
5. 每一个组件都需要编写在特定的文件夹中，并且引用相关的依赖，这样可以快速应用于不同的场景

### 4.I2C读取QAM芯片的组件编写

#### 4.1工作内容

1. 学习QAM芯片手册，了解相关的寄存器以及I2C读写方法
2. 编写相关组件，可以设置相关的活动模式以及量程
3. 编写组件实现读取X、Y、Z轴加速度功能

#### 4.2工作思考

1. 了解I2C协议的具体使用方法，了解使用I2C作为主机以及从机的读写时序以及ACK的发送时机，最后一帧数据通过设置NACK来判断全部数据是否发送完毕
2. 了解QAM芯片相关命令的寄存器使用方法，具体如设置量程，设置活动还是休眠模式。
3. 了解QAM芯片读取加速度的方法，通过读取特定的寄存器数据来实现对于加速度的检测

### 5.射频模块适配

#### 5.1工作内容

1. 适配E200x射频芯片，进行数据传输以及RSSI值的读取
2. 实现射频数据传输的超时重传功能，通过帧序列来保证发送数据的正确性，避免丢包情况的发送
3. 实现了对CMT2000射频芯片的适配

#### 5.2工作思考

1. 了解E200X芯片驱动的读写方式以及时序，时序如下图所示，主要的方法是通过应用程序调用core接口，然后通过port函数将数据发送出去，之后进入回调函数进行相关处理相关功能比如切换模式等
   <img src="https://image-1302263000.cos.ap-nanjing.myqcloud.com/img/image-20230727114618202.png" alt="image-20230727114618202" style="zoom: 50%;" />
2. 了解通过函数指针以及结构体进行对特定函数的封装，便于实现功能
3. 了解了当传输数据发生丢包的情况如何进行超时重传，如果速率较低的时候可以每一帧都重新发送，而不是使用窗函数来实现高速率的发送。加深了对网络协议的理解
4. 通过宏定义可以实现对不同芯片的适配

### 6.蓝牙GATTS传输与芯片自测

在完成3、4、5的工作，使用蓝牙GATTS协议传输数据。客户端轮询发送读取信息的命令，读取相关的车速，射频模块的RSSI值，以及QAM芯片的Z轴加速度。服务端在接到消息后，根据消息的数据写命令返回给客户端。在客户端通过多线程的模式收发数据，并且传给射频模块。

#### 6.1工作内容

1. 编写程序实现客户端针对数据传输的Profile、Server、character的相关配置，共有两个server，第一个server用于读写测试，第二个server用于4个character，分别用于车速的读取，射频RSSI读取，Z轴加速度的读取以及射频模块的命令发送
2. 服务端轮询读取车速，射频RSSI，Z轴加速度数据并且存储，根据数据的数值写回命令实现相关功能
3. 使用多个线程，一个线程负责循环读取OBD检测的车速，一个线程循环读取Z轴加速度，一个线程读取射频模块的RSSI值，最后一个线程用于蓝牙数据的收发
4. 编写芯片自测程序，可以通过宏定义来实现芯片的自测模式还是正常的数据收发模式

#### 6.2工作思考

1. 蓝牙的GATTS协议主要有三个层面分别是Profile、Server、Characteristic，每一个Profile拥有多个服务，每一个服务拥有不同的特征，数据的传输就是通过特征描述符和特征值进行的。
   <img src="https://image-1302263000.cos.ap-nanjing.myqcloud.com/img/image-20230702110851051.png" alt="image-20230702110851051" style="zoom: 67%;" />
2. Profile标准很多，可以根据自己的需要进行配置，并且可以根据需要自己添加相关的服务和特征
3. 了解如何使用多线程模型来提高芯片的利用率，并且学会如何使用消息队列以及锁来实现线程的安全与同步

## 工作总结

在乐鑫工作的将近两个月的工作中，我对自己的工作岗位和工作流程更加熟悉，感受到了公司浓厚的技术氛围，发现没有很多行政任务，大家都在处理技术上的问题，在和同事们的相处过程以及传帮带中我也获得许多成长。在未来的工作中，我也将继续学习专业知识，努力提高自己，让自己在工作岗位上做出更多的贡献。
